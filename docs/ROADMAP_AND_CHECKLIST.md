# SafeSpot-Local 开发演进路线与工程复盘清单 (Roadmap & Checklist)

本文档旨在明确项目进入实质性编码阶段后的**演进路径**（开发计划），同时提供一份**需要时刻被关注的监控清单**（Engineering Checklist），用于指导实现逻辑的严谨性，并便于后续的软件工程复盘。

---

## 🚀 第一部分：接下来的开发计划 (Development Roadmap)

在脚手架与基础架构搭建完毕后，接下来的开发将分为 4 个敏捷迭代（Sprints）稳步推进：

### Sprint 1: 后端基建与数据流打通 (Backend & Data IO)
* **目标**：彻底打通基于文件系统和 LowDB 的数据读写链路。
* **开发内容**：
  * 实现 `/data/knowledge/clauses.json` 的 LowDB 封装增删改查 API。
  * 编写基于 `fs` 的目录扫描接口：读取 `/assets/raw` 中的图片列表，并匹配对应 `/assets/meta` 下的关联 JSON 文件。
  * 实现图片上传 API (`multer`) 和边车 JSON 文件的写入 API。

### Sprint 2: 管理端 - 核心标注引擎开发 (Admin: Annotation Engine)
* **目标**：完成最复杂的前端交互部分：图像的百分比相对坐标标注。
* **开发内容**：
  * 封装 `CanvasAnnotator` React 组件：加载图片并覆盖透明 Canvas。
  * 实现鼠标拖拽事件：记录起止点，计算 `width=100%, height=100%` 坐标系下的 `x_ratio`, `y_ratio`, `w_ratio`, `h_ratio`。
  * 开发标注属性绑定模态框：在画框结束后，弹出表单让用户关联“违章分类”和“对应条款”，并提交给后端保存至 Sidecar JSON。

### Sprint 3: 用户端 - 找茬交互与智能判定 (User: Interaction Judge)
* **目标**：提供瞬时反馈和游戏化博弈体验。
* **开发内容**：
  * 开发考卷轮播结构，渲染题目图和剩余点击次数。
  * **碰撞检测核心逻辑落地**：将用户在图片上点击的 $(x, y)$ 转换为比例坐标，遍历该题当前的解答 JSON，执行二维包围盒/圆形区域的 Hit Test。
  * 命中或失败反馈：绘制高亮框、弹出条款原文的直观解析提示卡片。

### Sprint 4: 组卷指挥官与成绩仪表盘 (Assembler & Dashboard)
* **目标**：完成业务链路闭环。
* **开发内容**：
  * 开发“发布测试”界面：勾选多个已标注图片，设定分值权重，生成 `exams.json`。
  * 成绩汇算逻辑：答题结束后生成一条独立的用户得分 JSON 文件保存至 `/sessions/records/`。
  * 管理端报表：扫描成绩目录汇总成排行榜，利用 TailwindCSS 构建报表视图。

---

## 🛡️ 第二部分：时刻被关注的工程复盘清单 (Engineering Checklist)

> **研发纪律**：任何代码提交前、功能重构时、以及阶段性复盘会议中，都**必须（MUST）**对照本清单检查实现逻辑是否发生偏离。

### 1. 反引力解耦纯粹性校验
- [ ] **是否引入了不必要的数据库？** 
  * *检验标准*：全系统能否仅靠拷贝文件夹（含 Node 运行环境）在无网脱机设备上“双击启动”且数据不丢失？如果不能，说明引入了外部依赖。
  * *复盘追问*：新功能是否强行打破了 JSON Sidecar（边车附加）模式？

### 2. 坐标分辨率免疫测试 (Resolution Independence)
- [ ] **标注和判定是否使用了绝对像素 (px) ？**
  * *检验标准*：必须全局贯彻 `x_ratio` 和 `y_ratio`（即百分比系 0~1 的纯小数）。
  * *复盘追问*：在超宽屏设备标注的隐患部位，在手机端竖屏打开时，高亮框是否依然完美框中了隐患主体？（禁止由于容器自适应而导致的框选错位）。

### 3. 数据层无状态与高容错 (Stateless & Fault Tolerance)
- [ ] **如果只存在图片不存在对应的 JSON，系统会崩溃吗？**
  * *检验标准*：后端 `fs` 读取报错捕获，前端需将此类图片判定为“尚未标注”素材，不应抛出白屏异常。
  * *复盘追问*：如果手动在文件管理器删除了某张图片，后端的关联查询是否会自动优雅地忽略其边车 JSON 文件？

### 4. Vibe 驱动的心流交互体验
- [ ] **管理端到用户端的数据生效是否是瞬时的？**
### Sprint 5: 全局状态收拢与数据血脉贯通 (Data IO Integration)
* **目标**：彻底告别 Mock 伪数据预埋，通过真实的 Axios XHR 请求实现底层 Sidecar 联动。
* **开发内容**：
  * **API 代理映射**：配置 `vite.config.js` 的 `server.proxy`，解决前端到 `localhost:3000` 节点跨域及路由直通的问题。
  * **标注持久化连线**：完成 Admin 端框选坐标的真实落盘请求，触发后端 `fs` 写文件逻辑，并自动刷新图库列表标签。
  * **考试抽卷连线**：组卷指挥官发布的试卷信息，能以 `exams.json` 的形式物理落地，并在用户进入 `InteractionJudge` 时按图索骥抽选 `meta` 数据。

### Sprint 6: 用户心流极化与防误触工程 (UX & Fault Tolerance)
* **目标**：提供企业级工业软件的顺滑体验。
* **开发内容**：
  * **原图拉伸补偿**：增加上传图片前的压缩保护或对齐策略，防止极端纵横比（如全景长图）在 Canvas 中溢出导致热区标点偏移。
  * **热力图回溯**：在用户答题错误次数耗尽（MAX_MISS）后，不仅仅显像标注框，并支持悬停展示具体的由于未点中而扣除的“安全生产法”释义气泡。
  * **上传直通车**：实现基于 `multer` 在管理页左栏“图库存量库”的直接弹窗拖曳式物理文件上传。
  * **里程碑回溯**：完成从“百分比相对定位”到“博弈级判定”的完整验证。

### Sprint 9: 交互模块化与多人候考厅 (Modular Interaction & Lobby)
* **目标**：支持多考卷独立记分。
* **开发内容**：
  * **候考大厅**：User 端增加开考前置选卷逻辑。
  * **排行榜隔离**：ScoreKeeper 支持根据 `activeExamId` 过滤并展示专属榜单。

### Sprint 10: 数据库结构化转型 (SQLite Migration)
* **目标**：彻底告别碎片化 JSON，拥抱关系型数据模型。
* **开发内容**：
  * **存储底座重构**：引入 `better-sqlite3` 实现 `assets`, `annotations`, `exams`, `records` 等 5 张核心物理表。
  * **冷启动静默迁移**：实现后端启动时的 JSON-to-SQL 自动导入逻辑。

### Sprint 11: 数据巡检工具与碎片清理 (DB Inspector & Cleanup)
* **目标**：实现数据物理对账与存储瘦身。
* **开发内容**：
  * **DB Inspector**：前端开发表数据浏览器。
  * **碎片清理**：确认 SQL 数据无误后，一键物理删除冗余 JSON 边车文件。

---

## 🛡️ 第三部分：需要增加的强化复盘清单 (Enhanced Checklist)

### 6. 网络状态降级护城河 (Network Degradation)
- [ ] **是否在接口延迟时锁死了关键操作？**
  * *检验标准*：管理端在点按“持久化保存”的瞬间，按钮是否 `disabled` 并呈现 loading 态以防高频双击导致 `Lowdb` 写入锁死冲突。
  
### 7. JSON 文件破损自愈 (Sidecar Healing)
- [ ] **如果人为利用文本编辑器改坏了某个 JSON 导致 parse 失效**
  * *检验标准*：后端读取含有语法错误的 `.json` 时应当在总控 `try-catch` 中被静默拦截，返回默认的空数组而不是抛出 `500 Unhandled Promise Rejection` 导致 Node 进程崩溃。
