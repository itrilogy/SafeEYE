# SafeSpot-Local 开发演进路线与工程复盘清单 (Roadmap & Checklist)

本文档旨在明确项目进入实质性编码阶段后的**演进路径**（开发计划），同时提供一份**需要时刻被关注的监控清单**（Engineering Checklist），用于指导实现逻辑的严谨性，并便于后续的软件工程复盘。

---

## 🚀 第一部分：接下来的开发计划 (Development Roadmap)

在脚手架与基础架构搭建完毕后，接下来的开发将分为 4 个敏捷迭代（Sprints）稳步推进：

### Sprint 1: 后端基建与数据流打通 (Backend & Data IO)
* **目标**：彻底打通基于文件系统和 LowDB 的数据读写链路。
* **开发内容**：
  * 实现 `/data/knowledge/clauses.json` 的 LowDB 封装增删改查 API。
  * 编写基于 `fs` 的目录扫描接口：读取 `/assets/raw` 中的图片列表，并匹配对应 `/assets/meta` 下的关联 JSON 文件。
  * 实现图片上传 API (`multer`) 和边车 JSON 文件的写入 API。

### Sprint 2: 管理端 - 核心标注引擎开发 (Admin: Annotation Engine)
* **目标**：完成最复杂的前端交互部分：图像的百分比相对坐标标注。
* **开发内容**：
  * 封装 `CanvasAnnotator` React 组件：加载图片并覆盖透明 Canvas。
  * 实现鼠标拖拽事件：记录起止点，计算 `width=100%, height=100%` 坐标系下的 `x_ratio`, `y_ratio`, `w_ratio`, `h_ratio`。
  * 开发标注属性绑定模态框：在画框结束后，弹出表单让用户关联“违章分类”和“对应条款”，并提交给后端保存至 Sidecar JSON。

### Sprint 3: 用户端 - 找茬交互与智能判定 (User: Interaction Judge)
* **目标**：提供瞬时反馈和游戏化博弈体验。
* **开发内容**：
  * 开发考卷轮播结构，渲染题目图和剩余点击次数。
  * **碰撞检测核心逻辑落地**：将用户在图片上点击的 $(x, y)$ 转换为比例坐标，遍历该题当前的解答 JSON，执行二维包围盒/圆形区域的 Hit Test。
  * 命中或失败反馈：绘制高亮框、弹出条款原文的直观解析提示卡片。

### Sprint 4: 组卷指挥官与成绩仪表盘 (Assembler & Dashboard)
* **目标**：完成业务链路闭环。
* **开发内容**：
  * 开发“发布测试”界面：勾选多个已标注图片，设定分值权重，生成 `exams.json`。
  * 成绩汇算逻辑：答题结束后生成一条独立的用户得分 JSON 文件保存至 `/sessions/records/`。
  * 管理端报表：扫描成绩目录汇总成排行榜，利用 TailwindCSS 构建报表视图。

---

## 🛡️ 第二部分：时刻被关注的工程复盘清单 (Engineering Checklist)

> **研发纪律**：在此项目代码提交、重构以及复盘的过程中，本清单作为基础实现逻辑的约束参考。

### 1. 本地化独立性校验
- [ ] **是否引入了不必要的数据库？** 
  * *检验标准*：全系统能否仅靠拷贝文件夹（含 Node 运行环境）在无网脱机设备上“双击启动”且数据不丢失？如果不能，说明可能引入了外部依赖。
  * *复盘追问*：新功能是否打破了 JSON Sidecar（边车附加）或本地独立 SQLite 的模式？

### 2. 坐标分辨率独立测试 (Resolution Independence)
- [ ] **标注和判定是否使用了绝对像素 (px) ？**
  * *检验标准*：建议使用 `x_ratio` 和 `y_ratio`（即百分比系 0~1 的纯小数）进行记录。
  * *复盘追问*：不同比例屏幕间跨屏预览时，标注框是否能准确框中目标部位？

### 3. 数据层高容错处理 (Stateless & Fault Tolerance)
- [ ] **如果只存在图片不存在对应的边车或数据，系统会崩溃吗？**
  * *检验标准*：后端及前端应对缺失记录的图片作容错处理，判定为“尚未标注”素材，保证主链路不被阻断。
  * *复盘追问*：如果手动在文件管理器删除了某张图片，后端的查询是否会自动忽略或处理对应的孤立资料？

### 4. Vibe 驱动的心流交互体验
- [ ] **管理端到用户端的数据生效是否是瞬时的？**
### Sprint 5: 全局状态收拢与数据血脉贯通 (Data IO Integration)
* **目标**：彻底告别 Mock 伪数据预埋，通过真实的 Axios XHR 请求实现底层 Sidecar 联动。
* **开发内容**：
  * **API 代理映射**：配置 `vite.config.js` 的 `server.proxy`，解决前端到 `localhost:3000` 节点跨域及路由直通的问题。
  * **标注持久化连线**：完成 Admin 端框选坐标的真实落盘请求，触发后端 `fs` 写文件逻辑，并自动刷新图库列表标签。
  * **考试抽卷连线**：组卷指挥官发布的试卷信息，能以 `exams.json` 的形式物理落地，并在用户进入 `InteractionJudge` 时按图索骥抽选 `meta` 数据。

### Sprint 6: 交互与防误触工程优化 (UX & Fault Tolerance)
* **目标**：提供相对流畅和可靠的操作体验。
* **开发内容**：
  * **原图拉伸补偿**：增加上传图片前的压缩保护或对齐策略，尽量防止极端比例情况引起热区标点偏移。
  * **辅助提示**：在用户答题错误次数耗尽（MAX_MISS）后，展示标注框，并支持悬停展示该隐患点对应的违章释义气泡。
  * **上传入口**：在管理页内新增支持文件拖曳的上传组件。

### Sprint 9: 交互模块化与独立的测试厅 (Modular Interaction & Lobby)
* **目标**：支持不同批次/多考卷区分并独立记分。
* **开发内容**：
  * **候考大厅**：User 端增加开赛前置选卷步骤。
  * **排行榜隔离**：ScoreKeeper 支持根据考卷 `activeExamId` 展示专属榜单。

### Sprint 10: 数据库转型验证 (SQLite Migration)
* **目标**：逐步由零散文件过渡到 SQLite 关系型数据底座。
* **开发内容**：
  * **存储底座重组**：引入 `better-sqlite3` 实现核心表结构。
  * **冷启动数据迁移**：尝试实现后端启动时已有 JSON 至 DB 表的自动装填脚本。

### Sprint 11: 数据巡检与碎片清理 (DB Inspector & Cleanup)
* **目标**：建立数据可视与校验机制。
* **开发内容**：
  * **DB Inspector**：提供系统内表数据的简易透视功能。
  * **碎片清理**：在确认数据写入正常后，可使用清理接口删除老版 JSON 边车文件。

### Sprint 12: 精细化图形与交互升级 (UX Enhancement Pipeline)
* **目标**：优化 Canvas DOM 的交互控制与防呆设计。
* **开发内容**：
  * **图元与事件调整**：分离标识边界的光环与触控框缩放把手层的深度结构，修复部分圆形框选周边难以点选或重叠的问题。
  * **等比控制**：监听 `Shift` 或 `Ctrl` 键，提供绘制比例在 1:1 时的锁定功能。
  * **顶级状态共享**：在 `App` 与 `InteractionJudge` 层共享 `hoveredAnnoId` 等状态变量，通过 Props 下发实现不同面板组件间的高亮同步与跨界面快速启动。
  * **调整计分榜结构**：调整排版形式，将 `ScoreKeeper` 按等高结构整合于裁决面板旁侧，统一整体布局。

### Sprint 13: 品牌护城河与组卷管理升级
* **目标**：增加版权信息展示途径并优化试卷管线检索。
* **开发内容**：
  * **版权印记展现**：顶部栏标题栏触发版权展示浮窗设计。
  * **联合检索升级**：图库增加下拉筛选与搜索输入联合查询机制。
  * **删除保护**：对销毁图库等删除行为添加二次确认提示。

### Sprint 14: 发布状态管理闭环
* **目标**：规范完善试卷各生命周期状态流转的对应机制。
* **开发内容**：
  * **试卷状态存储**：引入保存草稿（draft）与发布可见（published）两种状态标记。
  * **试卷状态分发**：在考卷列阵中利用其身份标识进行过滤和下发。

### Sprint 15: 深层检索扩展与视窗比例控制
* **目标**：增强文本检索层级，扩充基础知识图谱内容库，改善弹性盒模型下的长宽比适配错误并优化各类边界防呆操作。
* **开发内容**：
  * **多级级联查询**：增强 AnnotationEngine 和 TestAssembler 的查询解析功能，支持对 `knowledgeTree` 节点（场景、类型、描述、法规）多关键词的空格拆分 AND 连带搜查。
  * **测试库基础构建**：补充 `db.js` 初始化测试字典，写入有关“建设施工、化工生产、仓储物流、公共办公、实验室研发”等 5 个基础场景的基础违章样板条目。
  * **严格选择状态防护**：修正了隐患指弹框后默认的首选项可能阻断下级依赖（即未主动变更无法正确加载后置菜单项）的漏洞，统一要求弹窗默认清除重置，促使用户显式变更。
  * **自适应框架重组**：脱离早期简单粗暴的 CSS `height: 100%` 导致宽/高度比异常的问题，转为借助 `ResizeObserver` 动态计算原图和容器占比并指派对应维度的优先级定宽定高计算。

---

## 🛡️ 第三部分：需要增加的强化复盘清单 (Enhanced Checklist)

### 6. 网络状态降级护城河 (Network Degradation)
- [ ] **是否在接口延迟时锁死了关键操作？**
  * *检验标准*：管理端在点按“持久化保存”的瞬间，按钮是否 `disabled` 并呈现 loading 态以防高频双击导致 `Lowdb` 写入锁死冲突。
  
### 7. JSON 文件破损自愈 (Sidecar Healing)
- [ ] **如果人为利用文本编辑器改坏了某个 JSON 导致 parse 失效**
  * *检验标准*：后端读取含有语法错误的 `.json` 时应当在总控 `try-catch` 中被静默拦截，返回默认的空数组而不是抛出 `500 Unhandled Promise Rejection` 导致 Node 进程崩溃。
