# 🛡️ SafeEye (safe-eye-pro)

> **基于“找不同”机制的交互式安全合规应知应会平台**
>
> **Design Philosophy:** 
> 这是一个旨在消除安全培训枯燥感的“反引力”工程。通过将合规条款转化为视觉博弈，让风险识别成为直觉。项目采用**本地 SQLite 结构化架构**，实现极致的轻量化与数据主权。

---

## 📖 产品意图 (Product Intent)

**SafeEye** 重新定义了安全合规学习。它不再是枯燥的 PPT 阅读，而是一个**“视觉反馈引擎”**：
1. **实景重构：** 采集真实的生产现场图片（`ori_pic`）。
2. **知识解构：** 通过管理端将法律法规、行业标准“缝合”到图片的具体坐标点上。
3. **沉浸博弈：** 用户在“找茬”的过程中，通过点击反馈实时获取关联的合规知识。

---

## 🏗️ 整体规划与工程架构 (Engineering Blueprint)

### 1. 存储架构：Local-First SQLite
项目采用 **单一物理文件数据库 (SQLite)** 的极简设计，兼具高性能与零配置：
*   **结构化底座:** 资产、标注、试卷、成绩等核心数据闭环存储在 `/server/data/safeeye.db` 中。
*   **解耦的延续:** 虽然引入了 SQL，但通过内存级事务和 `better-sqlite3` 驱动，系统依然可以通过拷贝整个项目目录实现无缝跨设备运行。

### 2. 空间定位：Relative Positioning Engine (RPE)
*   **零摩擦适配：** 所有标注坐标均以 `(x_ratio, y_ratio)` 存储。
*   **响应式判定：** 无论在 4K 屏幕还是平板电脑，判定逻辑自动根据容器宽高计算像素偏移，确保点击精度。

### 3. 业务流：从“隐患点”到“试卷视图”
*   **管理端：** 实现 Canvas 画布操作，拖拽即生成 `Spot`（隐患点），实时关联 `Clause`（条款）。
*   **组卷逻辑：** 采用“标签匹配算法”，支持根据业务场景（如：高空作业、实验室）自动聚合题目。

---

## 📂 文件夹结构 (Directory Structure)

```bash
safe-eye-pro/
├── data/                  # 本地物理存储 (SQLite & Assets)
│   ├── safeeye.db         # [核心] SQLite 结构化数据库文件
│   └── assets/            # 图片媒体资源
│       └── raw/           # 原始现场高清图片 (ori_pic)
├── src/
│   ├── admin/             # 管理端模块 (标注引擎、组卷器)
│   ├── player/            # 用户端模块 (交互判题、成绩单)
│   ├── engine/            # 核心逻辑 (RPE坐标计算、判题机)
│   └── shared/            # 通用 UI 组件与文件读写层
└── README.md
```

---

## 🛠️ 功能特性 (Feature Set)

### 管理端 (Command Center)
- **资产中心：** 支持 `ori_pic` 的快速导入与批量管理。
- **视觉标注：** 
    - 鼠标拖拽式绘制（圆/方），支持相对坐标自动转换，**支持按下 `Shift` 或 `Ctrl` 强制绘制等比例完美正圆形/正方形**。
    - 强制语义绑定：标注时必须勾选不符合项类型、关联条款。
    - **双向联动高亮：** 视图区图元与右侧属性明细清单列表基于 `hoveredAnnoId` 实现“悬停发光”的双向绑定。
    - **无死角拖拽：** 图元边界控制点与样式完全解析，解决圆形裁剪无法抓取边缘的问题。
- **动态组卷：** 
    - 智能模式：按场景、难度、数量自动抽题。
    - 精细化微调：手动设置每题分值、容错点击次数、答案可见性。
    - **一键开考：** 管理员可直接在已建卷宗列表点击 `Play` 按钮，跨端携带 ID 闪电开启大决战测试区。
- **分析看板：** 查看参与者得分排行及详细的错题分布。
- **数据巡检：** 提供 `DBInspector` 模块，便于实时对账物理表内容并支持一键清理旧式边车碎片。

### 用户端 (Interaction Terminal)
- **极简准入：** 姓名、手机、部门快速登记，即刻开测。
- **博弈体验：** 
    - 找不同机制：点击命中后即刻弹出合规解析，画布图元带有直观的序号映射注记（如：隐患 #1）。
    - 熔断机制：超过点击上限自动揭晓答案，强化记忆。
    - 沉浸式对账面板：答题演武场由**核心画布区**、**法条解释追踪边栏 (Judge Panel)** 与 **350px 宽度的实时龙虎榜 (ScoreKeeper 垂直列阵)** 严密包裹成无缝三联视窗结构。
- **即时反馈：** 测试结束自动计算得分、位次及等次（优/良/中/差）。

---

## 🚀 开发与部署 (Vibe-Style Deployment)

### 技术栈
- **Frontend:** React / Next.js (Fast & Responsive)
- **Local DB:** SQLite 3 (better-sqlite3) / Native File System API
- **Canvas Library:** 原生 DOM / 百分比坐标换算引擎
- **Styling:** Tailwind CSS

### 运行与拉起服务 (How to Run)

> **[重要通知]** 本项目基于“反引力架构”，后端（提供本地文件读写引擎）与前端（提供视觉交互视图）是完全解耦的实体，因此您需要 **两个终端窗口** 分别运行它们。

**第一步：启动数据支撑基座 (Backend Server)**
1. 打开第一个终端窗口。
2. 进入后端目录：`cd server`
3. 安装依赖：`npm install`
4. 启动服务：`npm run start` （将挂载于 http://localhost:3000）

**第二步：启动视觉表现引擎 (Frontend Client)**
1. 打开第二个独立的终端窗口。
2. 进入前端目录：`cd client`
3. 安装依赖：`npm install`
4. 启动画面：`npm run dev` （将挂载于 http://localhost:5173 且具备跨域代理连通能力）

等待编译完成，所有数据将通过 Axios 从 `server/data` 读写流转。

---

## 🛡️ 安全与合规说明
*   **数据隐私：** 采用本地存储，所有测试记录和原始图片均物理隔离存放，绝不上传云端。
*   **防断裂迁移：** 新增冷启动无损映射。服务端会在初次加载时检查数据库，如为空可自动将原始的独立知识库 `clauses.json` 抽取至物理表中，保障业务一致性。

---
*Created by SafeEye Engineering Team with Vibe Coding Philosophy.*