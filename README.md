# 🛡️ SafeEye (safe-eye-pro)

> **基于“找不同”机制的交互式安全合规应知应会平台**
>
> **Design Philosophy:** 
> 这是一个旨在改善安全培训体验的本地化工程项目。通过将合规条款与视觉交互结合，辅助风险识别。项目采用**本地 SQLite 架构**，追求轻量化与数据易管理。

---

## 📖 产品意图 (Product Intent)

**SafeEye** 提供了一种不同于传统 PPT 阅读的视觉交互式学习方式：
1. **实景重构：** 采集真实的生产现场图片（`ori_pic`）。
2. **知识关联：** 通过管理端将法律法规、行业标准关联到图元的具体坐标点上。
3. **互动环节：** 用户在寻找安全隐患的过程中，通过点击目标获取相应的合规知识。

---

## 🏗️ 整体规划与工程架构 (Engineering Blueprint)

### 1. 存储架构：Local-First SQLite
项目采用 **单一物理文件数据库 (SQLite)** 的极简设计，兼具高性能与零配置：
*   **结构化底座:** 资产、标注、试卷、成绩等核心数据闭环存储在 `/server/data/safeeye.db` 中。
*   **解耦的延续:** 虽然引入了 SQL，但通过内存级事务和 `better-sqlite3` 驱动，系统依然可以通过拷贝整个项目目录实现无缝跨设备运行。

### 2. 空间定位：Relative Positioning Engine (RPE)
*   **零摩擦适配：** 所有标注坐标均以 `(x_ratio, y_ratio)` 存储。
*   **响应式判定：** 无论在 4K 屏幕还是平板电脑，判定逻辑自动根据容器宽高计算像素偏移，确保点击精度。

### 3. 业务流：从“隐患点”到“试卷视图”
*   **管理端：** 实现 Canvas 画布操作，拖拽即生成 `Spot`（隐患点），实时关联 `Clause`（条款）。
*   **组卷逻辑：** 采用“标签匹配算法”，支持根据业务场景（如：高空作业、实验室）自动聚合题目。

---

## 📂 文件夹结构 (Directory Structure)

```bash
safe-eye-pro/
├── data/                  # 本地物理存储 (SQLite & Assets)
│   ├── safeeye.db         # [核心] SQLite 结构化数据库文件
│   └── assets/            # 图片媒体资源
│       └── raw/           # 原始现场高清图片 (ori_pic)
├── src/
│   ├── admin/             # 管理端模块 (标注引擎、组卷器)
│   ├── player/            # 用户端模块 (交互判题、成绩单)
│   ├── engine/            # 核心逻辑 (RPE坐标计算、判题机)
│   └── shared/            # 通用 UI 组件与文件读写层
└── README.md
```

---

## 🛠️ 功能特性 (Feature Set)

### 管理端 (Command Center)
- **资产中心：** 支持 `ori_pic` 的快速导入与批量管理。
- **多维度检索：** 系统支持基于法条原文、定性描述、业务场景等进行多层级的文本检索锁定图片。**最新支持多关键词空格 AND 操作匹配**，例如输入“消防 缺失”，可定位包含这些特征的图元。
- **测试知识库：** 配置涵盖建设施工现场、化工生产车间、仓储与物流、办公室及公共楼宇、实验室研发中心 **5 大核心场景**的测试用例参考字典。
- **视觉标注：** 
    - 鼠标拖拽式绘制（圆/方），支持相对坐标自动转换，**支持按下 `Shift` 或 `Ctrl` 绘制等比例正圆形/正方形**。
    - 强制语义绑定：标注时必须勾选不符合项类型、关联条款。
    - **双向状态联动：** 视图区图元与展示四级详情（场景、大类、定性、法则）的侧边栏实现了悬停状态的同步高亮展现。
    - **拖拽体验优化：** 改进图元边界控制点与样式逻辑，修复了圆形裁剪遮罩引发的操作死角问题。
    - **数据流转优化：** 修复了绘制标注后的定性弹窗中，首选项默认值可能导致级联数据加载异常的问题，**调整为要求首选项置空重选**，有助于保证数据的准确性。
- **动态组卷：** 
    - 智能模式：按场景、难度、数量自动抽题。
    - 精细化微调：手动设置每题分值、容错点击次数、答案可见性。
    - **快捷进入：** 管理员可在已建卷宗列表点击开始按钮，快速进入测试作答区。
- **分析看板：** 查看参与者得分排行及详细的错题分布。
- **数据巡检：** 提供 `DBInspector` 模块，便于数据表内容核对并支持清理冗余历史文件。

### 用户端 (Interaction Terminal)
- **基础准入：** 姓名、手机、部门快速登记，即刻开测。
- **交互体验：** 
    - 找不同机制：点击命中后弹出合规解析，图元附带直观的序号注记（如：隐患 #1）。
    - 容错机制：超过点击限制后揭晓答案，辅助记忆。
    - **测试界面：** 测试界面由**核心画布区**、**法条释义边栏 (Judge Panel)** 与 **成绩榜单列阵 (ScoreKeeper)** 组成三联视窗排布。
- **即时反馈：** 测试结束自动计算得分、位次及等次（优/良/中/差）。

---

## 🚀 开发与部署 (Vibe-Style Deployment)

### 技术栈
- **Frontend:** React / Next.js (Fast & Responsive)
- **Local DB:** SQLite 3 (better-sqlite3) / Native File System API
- **Canvas Library:** 原生 DOM / 百分比坐标换算引擎
- **Styling:** Tailwind CSS

### 运行与拉起服务 (How to Run)

> **[重要通知]** 本项目基于“反引力架构”，后端（提供本地文件读写引擎）与前端（提供视觉交互视图）是完全解耦的实体，因此您需要 **两个终端窗口** 分别运行它们。

**第一步：启动数据支撑基座 (Backend Server)**
1. 打开第一个终端窗口。
2. 进入后端目录：`cd server`
3. 安装依赖：`npm install`
4. 启动服务：`npm run start` （将挂载于 http://localhost:3000）

**第二步：启动视觉表现引擎 (Frontend Client)**
1. 打开第二个独立的终端窗口。
2. 进入前端目录：`cd client`
3. 安装依赖：`npm install`
4. 启动画面：`npm run dev` （将挂载于 http://localhost:5173 且具备跨域代理连通能力）

等待编译完成，所有数据将通过 Axios 从 `server/data` 读写流转。

---

## 🛡️ 安全与合规说明
*   **数据隐私：** 采用本地存储，所有测试记录和原始图片均物理隔离存放，绝不上传云端。
*   **防断裂迁移：** 新增冷启动无损映射。服务端会在初次加载时检查数据库，如为空可自动将原始的独立知识库 `clauses.json` 抽取至物理表中，保障业务一致性。

---
*Created by SafeEye Engineering Team with Vibe Coding Philosophy.*