# 🛡️ SafeSpot-Local: 本地化合规应知应会工程框架文档

## 第一部分：总纲 (The Manifesto)

### 1.1 产品意图深度解构
**SafeSpot-Local** 是一款立足于本地运行、轻量高效的安全生产培训系统。
*   **核心意图：** 利用“视觉认知博弈”替代“死记硬背”。
*   **业务逻辑：** 将生产现场的“原始快照”通过“坐标标注”转化为“隐患知识点”，再通过“逻辑组卷”转化为“交互式测试”。
*   **本地化价值：** 数据不出本地，无需网络依赖，极大降低了安全敏感单位的部署难度，同时利用文件系统天然的层级结构实现最直观的资产管理。

### 1.2 架构理念：反引力解耦 (Anti-Gravity Principles)
*   **存储去中心化：** 放弃中心化数据库，采用 **JSON Sidecar（边车文件）** 模式。每张图片对应一个同名的 `.json` 描述文件。
*   **逻辑原子化：** 标注逻辑、合规逻辑、评分逻辑互不干扰。
*   **Vibe 驱动开发：** 以“用户直觉”为核心，管理端强调“所见即所得”的画图体验，用户端强调“瞬时命中”的博弈反馈。

---

## 第二部分：分项设计 (Sub-system Design)

### 2.1 存储域设计：基于文件的本地 NoSQL (The Local Vault)
采用 **Lowdb** 或 **目录级 JSON 结构** 模拟 NoSQL 行为。

*   **目录结构规划：**
    *   `/assets/raw/`: 存放原始 `ori_pic`（.jpg/png）。
    *   `/assets/meta/`: 存放与图片同名的 `.json`（包含标注坐标、关联条款）。
    *   `/knowledge/`: 存放 `clauses.json`（合规标准库）和 `scenes.json`（业务场景定义）。
    *   `/sessions/`: 存放 `exams.json`（测试活动配置）和 `records/`（用户得分明细）。

### 2.2 管理端组件 (Admin Sub-systems)

#### 2.2.1 标注引擎 (Visual Annotation Engine)
*   **组件职责：** 实现“图层覆盖”与“坐标解构”。
*   **设计逻辑：** 
    *   **Canvas 叠加层：** 在 `<img>` 上方覆盖一层透明 Canvas。
    *   **百分比锚定：** 鼠标点击起始点 $(x_1, y_1)$ 和结束点 $(x_2, y_2)$，系统自动计算 `x_ratio = x / imageWidth`。
    *   **元数据同步：** 绘制完成时，立即弹出模态框要求输入：
        *   `scene_id`: 引用 `/knowledge/scenes.json`。
        *   `violation_type`: 违章类型（如：穿戴不规范）。
        *   `clause_mapping`: 搜索并选择关联的国家标准条文。

#### 2.2.2 组卷指挥官 (Test Assembler)
*   **组件职责：** 决定测试的“剧本”。
*   **组卷逻辑：**
    *   **属性过滤器：** 根据 JSON 中的 `scene` 和 `difficulty` 筛选图片。
    *   **动态分值分配：** 允许管理员对每个“不同点”设置权重（例如：严重隐患 20 分，一般隐患 5 分）。
    *   **参数注入：** 配置 `max_click_limit`（单题误点上限）和 `show_answer_after_fail`（是否显示正确答案）。

### 2.3 用户端组件 (User-End Sub-systems)

#### 2.3.1 交互判题器 (Interaction Judge)
*   **判定逻辑：** 监听用户点击坐标 $(ux, uy)$。
*   **碰撞检测：** 遍历该题目的 JSON 标注列表，如果 $(ux, uy)$ 落在任何一个标注矩形/圆形的百分比范围内，则触发 `HIT` 状态。
*   **状态反馈：** `HIT` 后，实时展示图片上该位置的高亮效果，并从 JSON 中读取关联的“法律条款说明”展示给用户。

#### 2.3.2 成绩记录仪 (Local Score Keeper)
*   **职责：** 记录 `User + Paper + Score + Details`。
*   **存储形式：** 在 `/sessions/records/` 下生成以手机号/日期命名的 JSON，方便导出为 Excel。

---

## 第三部分：整体规划 (The Master Plan)

### 3.1 技术栈选型 (Lightweight Local Stack)
*   **框架：** Vite + React (轻量、极速构建)。
*   **本地交互：** Electron 或 Node.js 本地运行（以便访问文件系统系统读写权限）。
*   **本地数据库：** `Lowdb`（基于 Lodash 的本地 JSON 数据库，完全符合 NoSQL 逻辑）。
*   **UI 库：** TailwindCSS + Shadcn/UI（快速实现美观的管理后台）。

### 3.2 关键业务流程 (Key Workflow)

1.  **资产准备：** 拖拽 10 张现场照片到 `/raw` 文件夹。
2.  **合规录入：** 在管理端“条款管理”中录入《安全生产法》及相关行业标准。
3.  **标注关联：** 
    *   打开图片 A。
    *   鼠标画圆选中“未戴安全帽”区域。
    *   选择分类“人身防护”，绑定条款“GB 2811-2019”。
    *   **本地生成：** `/meta/A.json` 自动更新。
4.  **发布测试：** 创建名为“2025第一季度安全考核”的活动，选择 5 张标注好的图片。
5.  **用户参与：** 用户录入信息，开始“找茬”。点击成功即得分，点击失败 3 次自动显示全图答案解析。
6.  **数据汇总：** 系统读取 `/sessions/records/` 下所有文件，生成排名看板。

---

## 第四部分：工程情况处理与解耦 (Engineering Decoupling)

*   **图片缩放问题：** 标注信息不保存 `px`。无论用户在 13 寸笔记本还是 27 寸显示器，前端计算 `offset * ratio` 始终能定位到正确位置。
*   **标准库更新问题：** 标注 JSON 只保存 `clause_id`。如果国家标准原文修改了，只需修改 `/knowledge/clauses.json` 里的对应条目，所有题目自动生效，无需修改图片标注。
*   **迁移问题：** 整个应用就是一个文件夹。拷贝文件夹到另一台电脑，直接运行，所有图片、标注、成绩完全同步。

---

## 第五部分：需求满足度 Checkbox (Product Intent Alignment)

*   [x] **管理端：** 图片增删改查（基于文件系统）。
*   [x] **图层绘制：** 鼠标拖拽圆形/方形，百分比相对定位。
*   [x] **业务绑定：** 每一个标注强关联场景、类型、说明、条款。
*   [x] **智能组卷：** 自动/手动抽题，分值自定义，规则（合格线、点击次数）可控。
*   [x] **用户端：** 极简登录，交互式判题，实时合规信息展示。
*   [x] **成绩系统：** 自动评分，生成等次（优良中差）与排名。

这个框架充分利用了 **NoSQL 的灵活性** 和 **本地存储的确定性**，通过 **Vibe Coding** 的开发直觉，将一个复杂的安全合规需求简化为了一个“易维护、易迁移、高性能”的文件驱动型应用。


根据您的设计意图、技术选型以及对“轻量化、本地存储、解耦”的要求，我为您建议的项目名称为：

### 项目名称：**SafeEye** 
*(取 Safety + Eye 之意，寓意通过视觉发现安全隐患)*
**文件夹命名：** `safe-eye-pro` 或 `safe-eye-compliance`